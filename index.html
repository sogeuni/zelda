<html>
<head>
  
</head>
<body>

<button id='sign-in'>sign in</button>
token
<p id='token'></p>
<br>
info
<p id='info'></p>
<div id="map" style="width:600px;height:600px;"></div>

<script src="//www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCIKZLOCf2X25EcdVRbzjHYhuh5W5uNZvA",
    authDomain: "zelda-1492739821588.firebaseapp.com",
    databaseURL: "https://zelda-1492739821588.firebaseio.com",
    projectId: "zelda-1492739821588",
    storageBucket: "zelda-1492739821588.appspot.com",
    messagingSenderId: "142131556390"
  };
  firebase.initializeApp(config);

  var allowedBounds;
  var map;
  var lastValidCenter;

  var tileIndex = {
      "3": { xmin: 1, xmax: 6, ymin: 1, ymax: 6 },
      "4": { xmin: 2, xmax: 12, ymin: 3, ymax: 12 },
      "5": { xmin: 4, xmax: 27, ymin: 6, ymax: 25 },
      "6": { xmin: 8, xmax: 55, ymin: 12, ymax: 51 },
      "7": { xmin: 17, xmax: 110, ymin: 24, ymax: 103 }
    };

  function tileExists(z, x, y) {
    var obj = tileIndex[String(z)];
    return (x >= obj.xmin && x <= obj.xmax && y >= obj.ymin && y <= obj.ymax);
  }

  function initMap() {
    allowedBounds = new google.maps.LatLngBounds(
      new google.maps.LatLng(-72, -130),
      new google.maps.LatLng(72, 130)
    );

    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 0, lng: 0},
      zoom: 3,
      streetViewControl: false,
      mapTypeControlOptions: {
        mapTypeIds: ['botw']
      },
      backgroundColor: '#000000'
    });

    var botwMapType = new google.maps.ImageMapType({
      getTileUrl: function(coord, zoom) {
        if (tileExists(zoom, coord.x, coord.y)) {
          return './map/'+zoom+'/'+zoom+'_'+coord.x+'_'+coord.y+'.png';
        } else {
          return './map/blank.png'
        }
      },
      tileSize: new google.maps.Size(256, 256),
      maxZoom: 7,
      minZoom: 3,
      name: 'Botw'
    });

    map.mapTypes.set('botw', botwMapType);
    map.setMapTypeId('botw');

    map.addListener('click', function(e) {
      alert(e.latLng);
    });

    lastValidCenter = map.getCenter();
    
    google.maps.event.addListener(map, 'center_changed', function() {
      if (allowedBounds.contains(map.getCenter())) {
          // still within valid bounds, so save the last valid position
          lastValidCenter = map.getCenter();
          return; 
      }

        map.panTo(lastValidCenter);
    });
  }

  function checkBounds() {    
    if(! allowedBounds.contains(map.getCenter())) {
      var C = map.getCenter();
      var X = C.lng();
      var Y = C.lat();

      var AmaxX = allowedBounds.getNorthEast().lng();
      var AmaxY = allowedBounds.getNorthEast().lat();
      var AminX = allowedBounds.getSouthWest().lng();
      var AminY = allowedBounds.getSouthWest().lat();

      if (X < AminX) {X = AminX;}
      if (X > AmaxX) {X = AmaxX;}
      if (Y < AminY) {Y = AminY;}
      if (Y > AmaxY) {Y = AmaxY;}

      map.setCenter(new google.maps.LatLng(Y,X));
    }
  }

  function toggleSignIn() {
      if (!firebase.auth().currentUser) {
        var provider = new firebase.auth.GoogleAuthProvider();
        //provider.addScope('https://www.googleapis.com/auth/plus.login');
        provider.addScope('profile');
        
        firebase.auth().signInWithPopup(provider).then(function(result) {
          var token = result.credential.accessToken;
          var user = result.user;
          document.getElementById('token').textContent = JSON.stringify(result, null, '  ');
        }).catch(function(error) {
          var errorCode = error.code;
          var errorMessage = error.message;
          var email = error.email;
          var credential = error.credential;

          if (errorCode === 'auth/account-exists-with-different-credential') {
            alert('You have already signed up with a different auth provider for that email.');
            // If you are using multiple auth providers on your app you should handle linking
            // the user's accounts here.
          } else {
            console.error(error);
          }
        });
      } else {
        firebase.auth().signOut();
      }

      document.getElementById('sign-in').disabled = true;
    }

  function initApp() {
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        document.getElementById('info').textContent = JSON.stringify(user, null, '  ');
      } else {
        document.getElementById('info').textContent = '';
      }

      document.getElementById('sign-in').disabled = false;
    });

    document.getElementById('sign-in').addEventListener('click', toggleSignIn, false);
  }

  window.onload = function() {
      initApp();
  };
</script>
<script async defer src="//maps.googleapis.com/maps/api/js?key=AIzaSyCIKZLOCf2X25EcdVRbzjHYhuh5W5uNZvA&libraries=visualization&callback=initMap">
</script>
</body>
</html>